<%#
 Copyright 2018 Shawn Chain <shawn.chain@gmail.com>
-%>

<%+header%>

<link rel="stylesheet" type="text/css" href="/css/dashboard.css" />
<script type="text/javascript" src="/js/jquery.min.js"></script>

<div id="content_lh_rf" class="content">
	<h2><%:Gateway Activity%></b></h2>
	<table id="tbl_lh_all">
	  <tbody><tr>
		<th><a class="tooltip" href="#">Time (CST)<span><b>Time in CST time zone</b></span></a></th>
		<th><a class="tooltip" href="#">Mode<span><b>Transmitted Mode</b></span></a></th>
		<th><a class="tooltip" href="#">Callsign<span><b>Callsign</b></span></a></th>
		<th><a class="tooltip" href="#">Target<span><b>Target, D-Star Reflector, DMR Talk Group etc</b></span></a></th>
		<th><a class="tooltip" href="#">Src<span><b>Recieved from source</b></span></a></th>
		<th><a class="tooltip" href="#">Dur(s)<span><b>Duration in Seconds</b></span></a></th>
		<th><a class="tooltip" href="#">Loss<span><b>Packet Loss</b></span></a></th>
		<th><a class="tooltip" href="#">BER<span><b>Bit Error Rate</b></span></a></th>
	  </tr>
	  <tr><td colspan="8">Loading ... </td></tr>
	<!-- javascript will update below rows
	<tr><td align="left">23:25:43 May 12th</td><td align="left">YSF</td><td align="left"><a href="http://www.qrz.com/db/BD3BAY" target="_blank">BD3BAY</a></td><td align="left">ALL&nbsp;at&nbsp;BG5HHP&nbsp;</td><td>Net</td><td>1.4</td><td>0%</td><td>0.0%</td></tr>
	<tr><td align="left">23:04:33 May 12th</td><td align="left">YSF</td><td align="left"><a href="http://www.qrz.com/db/BD7NJL" target="_blank">BD7NJL</a></td><td align="left">ALL&nbsp;at&nbsp;BG5HHP&nbsp;</td><td>Net</td><td>1.5</td><td>0%</td><td>0.0%</td></tr>
	-->
	  
	</tbody></table>
</div>
<br/>

<div id="content_lh_all" class="content">
	<h2><%:Local RF Activity%></b></h2>
	<table id="tbl_lh_rf"><tbody>
		<tr>
		<th><a class="tooltip" href="#">Time (CST)<span><b>Time in CST time zone</b></span></a></th>
		<th><a class="tooltip" href="#">Mode<span><b>Transmitted Mode</b></span></a></th>
		<th><a class="tooltip" href="#">Callsign<span><b>Callsign</b></span></a></th>
		<th><a class="tooltip" href="#">Target<span><b>Target, D-Star Reflector, DMR Talk Group etc</b></span></a></th>
		<th><a class="tooltip" href="#">Src<span><b>Recieved from source</b></span></a></th>
		<th><a class="tooltip" href="#">Dur(s)<span><b>Duration in Seconds</b></span></a></th>
		<th style="min-width:5ch"><a class="tooltip" href="#">BER<span><b>Bit Error Rate</b></span></a></th>
		<th style="min-width:8ch"><a class="tooltip" href="#">RSSI<span><b>Received Signal Strength Indication</b></span></a></th>
		</tr>
		<tr><td colspan="8">Loading ... </td></tr>
		<!-- javascript will update below rows
		<tr><td align="left">23:03:54 May 12th</td><td align="left">YSF</td><td align="left"><a href="http://www.qrz.com/db/BG5HHP-2DR" target="_blank">BG5HHP-2DR</a></td><td align="left">ALL&nbsp;</td><td style="background:#1d1;">RF</td><td>4.6</td><td style="background:#1d1;">0.6%</td><td></td></tr>
		<tr><td align="left">23:03:54 May 12th</td><td align="left">YSF</td><td align="left"><a href="http://www.qrz.com/db/BG5HHP-2DR" target="_blank">BG5HHP-2DR</a></td><td align="left">ALL&nbsp;</td><td style="background:#1d1;">RF</td><td>4.6</td><td style="background:#1d1;">0.6%</td><td></td></tr>
		-->
	</tbody></table>	  
</div>
<br/>

<script type="text/javascript">//<![CDATA[
    var lastHeard
	function ok() {
		window.location = '<%=controller%>/admin/mmdvm/dashboard';
	}

    /*remove the exist by compare the callsign and append to the begin of array*/
    function updateLastHeardList(l,e){
        for(i=0;i<l.length;i++){
            if(l[i].from == e.from){
                // found
                l.splice(i,1);
                //console.log("Update " + e.from)
                break;
            }
        }
        l.unshift(e);
    }

	// The timestamp
	function fixTimeOffset(x){
		var t;
        if(x.timestamp){
            var d = new Date(x.timestamp);
            t = d.getFullYear()  + "-" + 
                ("0" + (d.getMonth()+1)).slice(-2) + "-" + 
                ("0" + d.getDate()).slice(-2) + " " + 
                ("0" + d.getHours()).slice(-2) + ":" + 
                ("0" + d.getMinutes()).slice(-2) + ":" + 
                ("0" + d.getSeconds()).slice(-2) + "." + 
                ("00" + d.getMilliseconds()).slice(-3);
        }else{
            t = x.date + " " + x.time;
        }
		return t
	}

	function appendGatewayTable(x){
		var markup = "<tr><td align=\"left\">" + x.date + " " + x.time + "</td>";
		markup += "<td align=\"left\">" + x.mode + "</td>";
		markup += "<td align=\"left\"><a href=\"http://www.qrz.com/db/" + x.from + "\" target=\"_blank\">"+ x.from + "</a></td>";
		markup += "<td align=\"left\">&nbsp;" +  x.to; 
			if(x.via){markup += "&nbsp;at&nbsp;" + x.via};
			markup += "&nbsp;</td>";
		if(x.type == "RF"){
			markup += "<td style=\"background:#1d1;\">" + x.type + "</td>";
		}else{
			markup += "<td>" + x.type + "</td>";
		}
		markup += "<td>" + x.duration + "</td>"
		markup += "<td>" + (x.loss?x.loss:"0%") + "</td>"
		markup += "<td>" + x.ber + "</td></tr>";
		//console.log(markup)
		$("#tbl_lh_all tbody").append(markup);
	}

	function appendRFTable(x){
        var t = fixTimeOffset(x);
		var markup = "<tr><td align=\"left\">" + t + "</td>";
		markup += "<td align=\"left\">" + x.mode + "</td>";
		markup += "<td align=\"left\"><a href=\"http://www.qrz.com/db/" + x.from + "\" target=\"_blank\">"+ x.from + "</a></td>";
		markup += "<td align=\"left\">&nbsp;" +  x.to; 
			if(x.via){markup += "&nbsp;at&nbsp;" + x.via};
			markup += "&nbsp;</td>";
		markup += "<td style=\"background:#1d1;\">" + x.type + "</td>"
		if(x.duration){
			markup += "<td>" + x.duration + "</td>"
			// different color for ber
			var _ber = Number(x.ber.replace("%",""));
			if(_ber > 0 && _ber <= 1.9){
				markup += "<td style=\"background:#1d1;\">" + x.ber + "</td>"
			}else if(_ber >= 2.0 && _ber <= 4.9 ){
				markup += "<td style=\"background:#fa0;\">" + x.ber + "</td>"
			}else if(_ber > 4.9){
				markup += "<td style=\"background:#f33;\">" + x.ber + "</td>"
			}else{
				markup += "<td>" + x.ber + "</td>"
			}
		}else{
			markup += "<td style=\"background:#f33;\">TX</td>"
			markup += "<td ></td>"
		}
		
		markup += "<td>" + (x.rssi?x.rssi:"") + "</td></tr>";
		$("#tbl_lh_rf tbody").append(markup);
	}

	function mergetNetAndRFActivities(x){
		if(x.lh_all) return;
		var lh_all = [];
		if(x.lh_net){
			x.lh_net.forEach(function(e){
				lh_all.push(e);
			});
		}
		if(x.lh_rf){
			x.lh_rf.forEach(function(e){
				lh_all.push(e);
			});
		}
		lh_all.sort(function compare(a,b){
			if(a.timestamp > b.timestamp){
				return -1;
			}else if(a.timestamp < b.timestamp){
				return 1;
			}else{
				return 0;
			}
		});
		x.lh_all = lh_all;
	}

	function updateTable(x){
        var changed = false;
		mergetNetAndRFActivities(x);
        if(!lastHeard){
            lastHeard = x;
            changed = true;
        }else{
            if(x.lh_all && x.lh_all.length > 0){
                // update the cached lastHeard data
                x.lh_all.forEach(function(e){
                    updateLastHeardList(lastHeard.lh_all,e)
                });
                changed = true;
            }
            if(x.lh_rf && x.lh_rf.length > 0){
                x.lh_rf.forEach(function(e){
                    updateLastHeardList(lastHeard.lh_rf,e)
                });
                changed = true;
            }
        }

        if(!changed){
            //console.log("no data change");
            return;
        }

        // update UI
        // remove the last n-1 rows(keep the table headers)
        var rows = $("#tbl_lh_rf tr")
        if(rows.length > 1){
            rows.slice(1 - rows.length).remove();
        }
        rows = $("#tbl_lh_all tr")
        if(rows.length > 1){
            rows.slice(1 - rows.length).remove();
        }
        // fill up with updated data
        if(lastHeard.lh_all){
            lastHeard.lh_all.forEach(function(x){
                appendGatewayTable(x);
            });
        }
        if(lastHeard.lh_rf){
            lastHeard.lh_rf.forEach(function(x){
                appendRFTable(x);
            });
        }
	}
	function checkData() {
        var _params = {}
        if(lastHeard && lastHeard.offset){
            _params.offset = lastHeard.offset
        }
		XHR.get('<%=REQUEST_URI%>/data', _params, function(x, data) {
			updateTable(data)
			window.setTimeout(checkData, 500);
		});
	}

	window.onload = function(){
		checkData()
	}
//]]></script>

<!--
<input class="cbi-button cbi-button-apply" type="button" value="<%:Restart MMDVMHost%>" onclick="restart(this)" />
<p class="alert-message" style="display:none">
	<img src="<%=resource%>/icons/loading.gif" alt="<%:Loading%>" style="vertical-align:middle" />
	<span id="reboot-message"><%:Restarting MMDVMHost...%></span>
</p>
-->
<%+footer%>
